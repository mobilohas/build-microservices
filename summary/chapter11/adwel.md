# 보안
`
마이크로 서비스 환경을 운영할 때 서비스간 보안 문제를 어떻게 해야 할지
인증 과정은 어떻게 수행할 것인지 알아보자
`


## 핵심 원칙
### 최소 권한의 원칙
- 시스템 엑세스 권한을 부여할 때 기능을 수행에 필요한 권한을 최소한으로 부여 해야 함
- 제한된 시간 동안만 엑세스 권한을 부여하여 탈취될 경우 악영향을 더욱 제한해야 함

### 심층 방어
- 공격자로부터 방어하기 위해 여러 보호 장치를 골고루 갖추는 것이 중요
- 해당 마이크로서비스가 수행할 수 있는 범위를 제한하면 보안 문제 발생 시 전파 정도를 낮출 수 있음

### 자동화
- 자동화를 사용하여 보안키를 교체하고 도구를 사용하여 잠재적인 보안 문제를 보다 쉽게 감지할 수 있음

### 배포 프로세스에 보안 주입
- 테스트가 주요 배포 프로세스가 된것 처럼 보안도 다르지 않아야 함
- 개발자가 보안 관련 사항에 일반적인 인식을 가져야 하며, 쉽게 구축할 수 있도록 도구를 개선해야 함

## 사이버 보안의 다섯 가지 기능
- 잠재적인 공격자가 누구인지, 공격 대상이 무엇인지, 가장 취약한 곳은 어디인지 식별하라
- 잠재적인 해커로부터 주요자산을 보호하라
- 최선의 노력에도 불구하고 공격이 발생했는지 감지하라
- 나쁜 일이 발생했다는 것을 알게 되면 대응하라
- 사고 발생 후 복구하라

### 식별
- 공격자가 무엇을 원하는지 공격자의 사고방식으로 행동하여 위협 모델링을 해야 함
- 가장 큰 위험을 파악할 시간을 가져 보완 하지 않으면 후에 문제 발생 시 더 많은 시간을 투자해야 함

### 보호
- 가장 가치 있거나 취약한 자산을 식별한 후에 적절하게 보호가 되고 있는지 확인해야 함
- 마이크로서비스 아키텍쳐는 공격할 수 있는 표면적이 훨씬 넓기 때문에 보호해야 할 대상이 많음

### 탐지
- 마이크로 서비스 아키텍쳐를 사용하게 되면 원천 정보가 크게 증가하여 문제 탐지가 더욱 어려움
- 불량행위를 감지하는 다양한 도구 검토 필요

### 대응
- 침해 범위와 노출된 데이터를 이해야여 추가 손상을 제한 해야 함
- 조직의 다른 부서와 대화하여 내부 상황을 처리하는 방법을 중요하게 고려

### 복구
- 복잡한 마이크로 서비스 환경을 복구 하기위해 다양한 자동화 필요 (백업 등..)

## 애플리케이션 보안의 기초
### 자격 증명
- 사람 또는 시스템에게 제한된 자원에 대한 엑세스 권한을 부여
- 자격 증명은 모두 교체, 폐기, 권한의 문제를 고려해야 함

#### 사용자 자격 증명
- 이메일 및 패스워드 조합과 같은 사용자 인증 정보 탈취는 해킹에서 많은 비율을 차지
- 패스워드와 같은 것들을 올바르게 처리하는 권고안을 따랴야 함

#### 시크릿
- 인증서, API 키 등 마이크로 서비스가 작동하는데 필수적인 정보
- 어떻게 생성,배포되며 어디에 저장되있는지 모니터링 할 수 있어야 하며 쉽게 교체 가능해야 함
- 많은 시크릿을 관리해야 된다면 적절한 도구를 사용해야 함

#### 교체
- 자격 증명을 자주 교체하여 피해를 제한하는 것이 이상적
- 시간 제한된 자격 증명을 사용하여 해킹 예방 및 시스템에서도 유용하게 사용 가능
- 키 교체의 결과로 시스템의 작동을 멈춰 장애를 발생하지 않도록 주의

#### 폐기
- 자격 증명의 유출되면 신속하게 폐지하고 재 생성할 수 있어야 함
- 긴급 폐기를 할 수 있는 서비스 환경을 구축해야 함

#### 범위제한
- 자격 증명의 범위를 제한하는 것은 최소 권한 원칙을 수용하는 개념의 핵심
- 자격 증명을 고유하게 사용하면 문제 발생시 특정 범위 교체 및 쉽게 추적 가능함
- 세분화된 자격 증명을 대규모로 관리하기 어려움 자동화가 필수적

### 패치
- 지속적인 패치 적용으로 보안을 예방할 수 있음
- 오랜시간 동안 서비스하고 있는 컨테이너는 패치를 적용할 수 없어 보안에 취약할 수 있음
- 사용하고 있는 라이브러리 프레임워크가 취약성이 있는지 지속적으로 확인해야 함 관리가 어렵다면 도구를 사용

### 백업
- 데이터 저장소 기술의 발전 혹은 복제 기능에 현옥되어 데이터 백업 우선순위를 낮춰서는 안됨
- 백업본으로 복구를 정기적으로 실행하여 백업 데이터가 정상적인 상태인지 확인해야 함

### 재구축
- 정기적으로 서버를 재구축하고 자격 증명을 교체한다면 공격자의 영향을 크게 제한할 수 있음
- 컨테이너를 사용하면 이를 달성하기가 쉬움

## 암묵적 신뢰 대 제로 트러스트
### 암묵적 신뢰
- 경계 내부에서 만들어지 서비스에 대한 호출은 암묵적으로 신뢰
- 공격자가 네트워크 안으로 침투하면 모든 서비스에 액세스 가능

### 제로트러스트
- 공격자가 이미 존재 한다는 적대적인 환경에서 작업한다고 가정, 경계의 개념은 의미 없음
- 사용되는 환경에 대해 훨씬 더 유연하게 대처 가능하며, 더 넓은 환경이 안전할 것이라고 기대하지 않아도 됨
- 환경을 구성하기가 까다롭기 때문에 지속적으로 투자해야함

### 스펙트럼
- 모든 보안 구현 비용은 위협모델에 의해 정당화되고 주도되어야 함
- 데이터 민감도에 따라 영역을 나누고(공개, 비공개, 비밀) 특정 영역에만 접근할 수 있도록 서비스 영역도 분리
- 일부 영역에서만 제로 트러스트 접근 방식을 사용하여 관리 포인트를 줄일 수 있음

## 데이터 보안
### 전송 중인 데이터
- 전송 중인 데이터 보호를 위한 특정 기술의 지원 여부를 확인
#### 서버 신원
- 통신 중인 서버가 누군인지를 식별하는 것은 추가적인 보호 기능을 제공
#### 클라이언트 신원
- 클라이언트와 서버의 시원을 모두 확인하려면 상호 인증이 필요
- 상호 TLS를 사용해 인증을 수행하여 해결
#### 데이터 가시성
- HTTPS 나 상호 TLS를 사용하여 중간자가 데이터를 볼 수 없게 암호화 해야 함
#### 데이터 조작
- 암호화를 사용하면 일부 해결 가능
- 암호화를 하지 않고 데이터 조작을 방지하려면 해시 기반 메시지 인증 코드(HMAC)을 사용
### 보관 중인 데이터
- 데이터를 암호화 하여 심층 방어

#### 잘 알려진 것을 사용하라
- 정기적으로 패치되며 잘 알려진 암호화 알고리즘을 사용하여 데이터를 암호화 해야 함 
#### 암호화 대상 선택
- 암호화는 연산 오버헤드가 발생할 수 있음
- 어떤 데이터가 암호화 되어야 하는지 판단하여 부분적으로 진행 
#### 절약하라
- 데이터 수집은 필요한 만큼 진행
- 영구적으로 저장하지 않아도 되는 데이터는 주기적으로 정리
#### 키가 전부다
- 데이터를 암호화 하는 키는 암호화된 데이터 저장소와 다른 곳에서 관리되어야 함
#### 백업 암호화
- 데이터가 민감할 경우 백업 데이터도 암호화를 진행 해야 함

## 인증과 권한 부여
- 식별된 사람인지 확인하는 과정이 인증, 인증을 받는 당사자를 권한 주체라고 함
- 권한 부여는 권한 주체를 허용된 행위와 매핑하는 메커니즘
- 여러 서비스에 대한 인증과정을 단순하게 하기 위해 SSO를 사용

### 서비스 간 인증
- TLS 상호 인증과 API 키를 사용하여 서버와 클라이언트 사이의 인증 가능

### 사람 인증
- 일반적으로 아이디, 패스워드를 사용 했으나 현재는 MFA 인증을 사용 (SMS, NFC ..)

### 일반적인 SSO 구현
- 여러 다운스트림 서비스나 애플리케이션과 상호작용하게 되더라도 세션당 한 번만 인증
- ID 제공자는 권한 주체를 인증해 주며, 완료되면 서비스 제공자 에게 정보를 제공해 엑세스 권한을 부여
- ID 제공자는 권한 주체가 누구인지에 대한 정보를 시스템에게 제공, 시스템은 그 권한 주체가 수행할 수 있는 행위를 결정

### SSO 게이트 웨이
- ID 제공자는 서비스 내에 존재 할 수 있지만 이는 마이크로서비스 전반에 걸쳐 중복 기능을 의미
- SSO 게이트 웨이를 사용하여 인증이 필요하다면 ID 제공서비스에게 전달 
- 다운스트림 서비스가 사용자 이름이나 역할과 같은 권한 주체에 대한 정보를 받는 방법을 해결해야 함
- 인증에 대한 책임을 게이트웨이로 넘기려고 결정한 경우 마이크로 서비스가 개별적으로 어떻게 작동하는지 추론하기가 어려움

### 세밀한 권한 부여
- 게이트웨이가 인증의 결과로 권한 주체에 대한 속성을 추출하여 그룹이나, 역할로 분류
- 그룹, 역할 내에서 좀더 세밀한 권한부여는 서비스내에서 결정하고 개발해야 함

### 혼동된 대리인 문제
- 인증을 마친 권한 주체가 호출한 요청에 의하여 SSO 게이트웨이 통과하고 여러 마이크로 서비스 내에서 호출 체인이 발생할 경우 취약점에 노출될 수 있음
- 다운스트림 서비스는 암묵적 신뢰를 취하여 업스트림 서비스의 요청을 처리할 것이기 때문, 이 부분에서 정보 유출일 발생할 수 있으니 조심

### 중앙 집중식 업스트립 권한 부여
- 혼동된 대리인 문제를 피하려면 시스템에게 요청을 수신하는 즉시 호출체인에 속해있는 모든 서비스에 대한 권한 부여를 수행해야 함
- 하지만 위 방법은 독립적인 방법으로 서비스가 하기가 어려움 그럴경우, 따라서 제로 트러스트 방식으로 구현하는 것도 고려

### 분산식 권한 부여
- 일반적으로 중앙 집중식 권한 부여의 문제를 다운 스트림 마이크로 서비스에서 해결
- 요청하는 사람에 대한 정보를 다운 스트림에게 안전하게 전달하기 위해 JSON 웹 토큰을 사용

### JSON 웹토큰
- 전달하고 싶은 데이터를 문자열로 토큰에 담아 서명, 암호화하여 안전하게 전달 가능
- 다양한 프로토콜을 통해 쉽게 전달 가능하고, 만료시간도 설정 가능

#### 포맷
- JSON 구조로 되어 있어 원하는 모든 것을 포함할 수 있음
- 헤더(서명된 알고리즘), 페이로드(클레임 정보), 서명으로 구성
- 서명은 데이터가 조작되어 있는지, 누구에 의하여 생성됐는지 확인
#### 토큰사용
- 특정 요청에 대해 JWT 토큰을 생성되고 다운스트림 아미크로 서비스로 전달
- JWT는 클라이언트에 저장해서 사용하며, 서버는 토큰을 발급할 때 만료시간을 설정하여 남용을 제한
#### 문제점
- 토큰이 유용한지 확인하기 위해 키를 사용하기 때문에 키 관리가 중요 
- 토큰이 만료되는 시간을 설정 할 때 요청을 처리하는 시간도 같이 고려해야 함
- JSON 형식이기 때문에 데이터 저장을 쉽게 남용한다면 이는 토큰의 크기 문제로 이어짐

