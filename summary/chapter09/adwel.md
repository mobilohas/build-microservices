# 테스트
`
다양한 테스트 단위를 어떠한 기준으로 적절히 분리 할지
또 마이크로 서비스 테스트 환경에서는 기존 모놀리식 테스트 환경과 달리 
어떠한 점을 고려해봐야 할지 알아보자
`

## 테스트 유형
- 인수 테스팅 - 모듈간의 상호작용(프로그래밍, 비즈니스)
- 탐색 테스팅 - 수동으로 탐색하여 테스팅(비즈니스, 제품평가)
- 단위 테스팅 - 기능단위 테스트(기술대면, 프로그래밍)
- 속성 테스팅 - 응답시간, 보안, 성능(제품평가,기술대면)

## 테스트 범위
- 단위 테스트는 격리성이 잘 보장되여 문제 원인을 파악하고 수정하기 쉬움
- 엔드투엔드 테스트는 테스트 범위가 증가하고 단위 테스트 보다 기능이 잘 작동한다는 것을 보장 할 수 있음

### 단위 테스트
- 외부 파일,네트워크를 사용하지 않음
- 로컬에서 많은 테스트를 빠르게 실행할 수 있음
- TDD의 부산물인 속성 기반 테스팅은 단위 테스트에 속함

### 서비스 테스트
- 마이크로서비스환경에서 서비스 테스트는 개별 서비스의 기능을 테스트하는 개념
- 다른 마이크로서비스와 어느정도 격리되어 있음
- 단위 테스트보다는 시간이 더 오래 거림
- 엔드투엔드 테스트보다 취성이 낮음

### 엔드투엔드 테스트
- 운영환경과 가장 근접한 테스트 
- 여러 서비스 의존성이 묶여 있어 수행하기 까다로움

### 절충안
- 테스트의 범위가 커질수록 신뢰도가 높아지지만 속도, 비용이 많이 듬
- 테스트 유형에 대한 장단점을 고려하여 단위,서비스, 엔드투엔드 테스트 비율을 적절히 분배해야 함

## 서비스 테스트의 구현
- 마이크로 서비스 테스트는 독립적이여야 함 
- 테스트에서 문제가 발생시 마이크로서비스 자체의 문제로 매핑되어야 함
- 서비스 테스트 집합 필요시 다운스트림 서비스를 스텁으로 구성할 수 있음

### 목 또는 스텁 사용
- 요청에 대해 준비된 고정 응답을 회신 하려면 스텁 서비스를 구성
- 호출 횟수 또는 상호작용을 검증하기 위해서는 목을 사용
- 목은 과도하게 사용시 테스트가 취약해 질 수 있음

### 더 영리한 스텁 서비스
- 마운티 뱅크를 사용하여 보다 쉽게 스텁 서버와 목 서버를 구성할 수 있음

## 까다로운 엔드투엔드 테스트의 구현
- 엔드투엔드 테스트는 훨씬 더 넓은 범위를 다루고 있어 시스템 작동을 더욱 확신하게 해줌
- 하지만 테스트가 느리고 실패를 찾아내기 더 여려워짐 
- 여러 마이크로 서비스 배포 파이프 라인을 하나의 엔드투엔드 테스트로 팬인해야 함

### 불안정하고 깨지기 쉬운 테스트
- 테스트 범위가 증가살수록 구성 요소도 증가하고 이는 불안정한 테스트로 이어짐
- 마이크로 서비스 환경에서의 통합 테스트 실패는 로직 뿐만 아니라 다수의 프로세스, 경합 조건, 타임아웃 등 다양한 이유가 있음
- 불안정한 테스트가 있다면 찾아내서 수정하고, 수정할 수 없다면 제외 해야 함
- 수정 시 멀티 프로세스, 스레드 환경에 작동할 수 있는 코드인지 검증해야 함
- 또 불안정한 테스트를 더 작은 범위의 전환할 것을 고려

### 누가 엔드투엔드 테스트를 작성하는가?
- 마이크로서비스 간 소유권 경합이 발생하면 테스트가 비효율적으로 작성될 여지가 있음
- 문제가 발생시 팀간 서로 회피하게 될 수 있으며, 원인을 찾기 어려움
- 엔드투엔드 테스트는 소유권 문제가 발생할 수 밖에 없으며 유연하게 대처해야 함
- 특정 수준의 조직 규모에서는 엔드투엔트 테스트를 벗어나려고 함

### 앤드투엔드 테스트는 얼마나 오래 걸릴까?
- 엔드투 엔드테스트는 회귀 테스트 까지 한다면 너무 많은 시간이 필요
- 문제를 발견하고 해결하는 과정에서 병목이 생김
- 시간이 오래 걸리는 고비용 테스트를 지능적으로 선별하고 제거 하는 것은 매우 어려운 일, 정답이 없음

### 대규모 적체
- 엔드투엔드 테스트를 실행하고 해결하는 과정에서 더 많은 코드 변경 또는 다른 서비스가 변경될 수 있음
- 테스트 문제를 해결할 때까지 체크인을 막는것은 매우 비효율적
- 결론적으로는 테스트 집합을 보다 빠르게 만드는 것이 중요함

### 메타 버전
- 여러 서비스를 함꼐 배포하는 것을 수용하는 방식은 서비스 결합성을 높이게 됨
- 이는 모놀리식 방식보다 더 나쁜 상황을 만들 수 있음
- 통합된 서비스 버전이 아닌 각각의 서비스 단위로 버전 번호를 관리해야 함

### 독립적인 테스트 기능성 부족
- 독립적인 배포를 보장한다는것은 독립적인 테스트가 가능해야 함
- 여러 서비스의 테스트가 실행되는 공유 환경은 심각한 문제를 야기할 수 있음

## 엔드투엔드 테스트를 피해야 할까?
- 마이크로 서비스 환경에서의 엔드투엔드 테스트는 경합, 결합 등 다양한 문제가 발생할 수 밖에 없음
- 마이크로 서비스는 결국 독립적으로 릴리즈가 가능해야 하며 소비자들에게 영향을 주면 안됨
- 마이크로서비스 인터페이스에 대한 명시적 스키마를 사용하면 구조적 중단을 포착하는데 유용함
- 구조적 중단을 쉽게 포착할 수 있다면 엔드투엔드 테스트의 필요성이 줄어듬

### 계약 테스트와 소비자 주도 계약
- 소비자가 제공자에게 마이크로 서비스에 기대하는 동작 방식을 표현하여 제공
- 자체 마이크로 서비스 테스트가 아닌 외부 서비스의 작동 방식을 소비자가 지정 하는 것임
- 소비자 주도 계약은 마이크로서비스를 제공하는팀과 소비하는 팀간의 의사소통을 도와줌
- 초점은 다르지만 서비스 테스트와 같은 범위라고 할 수 있음
- CDC를 받은 제공자는 빌드 중 CDC에게 문제가 발생할 경우 영향도 파악이 쉬어짐

#### 팩트
- 소비자는 제공자에게 기대하는 요청을 정의하여 로컬로 실행, 로컬 스텁으로도 동작, JSON 명세서 생성
- 제공자게에 명세서를 전달하여 검증
- 직접 전달하지 않고  CI/CD를 통해 버전별로 관리,접근 할 수 있음(팩트 브로커)
- 팩트가 소비자 주도 계약을 위한 유일한 도구는 아님 (스프링 클라우드 컨트랙)

#### 대화가 중요해
- CDC는 마이크로서비스 인터페이스를 정의하는 논의를 쳬계화 하고, 발전 방향성 대화의 시발점이 됨

### 결론
- 엔드투엔드 테스트는 구성요소가 많아 질수록 단점이 많아짐
- CDC, 모니터링을 붙이는 것에 대한 비용을 엔드투엔트 테스트 안정성에서 투자 할 수도 있음
- 하지만 완전히 이해하지 않은 상태로 엔드투엔드 테스트를 버리면 안됨

## 개발자 경험
- 로컬에서 실행해야 하는 마이크로 서비스의 수, 다양한 기술 스택은 개발자에게 어려움을 줄 수 있음
- 팀 밖에 있는 마이크로서비스가 있다면 로컬 스텁 환경을 구성해야 함

## 운영 전 테스트에서 운영 중 테스트로
- 운영 전 테스트는 완벽하지 않음, 더 많은 트래픽, 예상치 못한 사용 패턴 등 다양한 문제가 발생 할 수 있음
- 테스트 작성을 통하여 해당 문제를 어느정도 해결할 수 있지만 특정 시점부터 수확 체감이 발생
- 분산 시스템에서 모든 잠재적인 문제를 잡아내는 것은 불가능
- 운영환경에서도 테스트를 적용할지 검토해야 함

### 운영 환경 테스트 유형
- 운영환경에서 어플리케이션이 올바르게 실행 되고 있는지 (스모크 테스트)
- 카나리아 릴리즈를 사용하여 일부 사용자들에게 테스트
- 가짜 사용자를 만들어 실제 처럼 테스트

### 운영환경에서 안전한 테스트 만들기
- 운영환경에서 수행되는 테스트는 안전해야 함
- 가짜 사용자 행동 테스트는 위험할 수 있으나 실제 사용 패턴과 비슷해 큰 도움을 줌

### MTBF보다 MTTR?
- 평균 무고장 시간과 평균 수리시간 균형을 잘 조절 해야함 
- 테스트는 운영환경에서 발생하는 모든 문제를 해결해 주지 않음 
- 빨리 발견하고 수정할 때 도움을 주는 다양한 모니터링도 중요함

### 교차 기능 테스트
- 트래픽, 보안, 접근성 등 교차기능 요구사항(CFR)도 존재, 교차 기능 테스트는 속성 테스트에 속함
- 엔드투엔드 테스트에서 병목 발생 시 더 작은 범위의 테스트를 작성하는 것은 CFR에 적합 
- CFR 테스트도 정기적으로 검토하고 고려해야함

### 성능 테스트
- 마이크로 서비스는 더 많은 호출이 발생하기 때문에 시스템 작동 속도를 저하시킬 수 있음
- 성능 테스트 환경은 운영환경과 거의 동일해야 함 
- 성능 테스트는 목표를 정하고 정기적으로 수행하고 개선해야 함

### 견고성 테스트
- 인스턴스에 장애가 전체 시스템에 영향을 미쳐서는 안됨
- 견고성 테스트는 구현하기 까다로울 수 있지만 마이크로 서비스 환경에서는 고려 해야 함
- 서비스 메시, 회로 차단을 사용하여 처리 할 수 있음
