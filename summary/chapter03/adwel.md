# Chapter 03 모놀리스 분해
`
모놀리식 서비스에서 어떤 서비스를 먼저 분리해야 좋을지, 마이그레이션에 도움이 될만한 패턴을 익히고
과정에서 발생할 수 있는 문제는 어떤게 있는지, 어떻게 처리 해야할지 고민
`

## 목표를 가져라
- 마이크로 서비스 전환을 함으로써 어떤것 이룰 수 있는지 생각해야 함
- 합리적인 의사결정에 의해 마이크로 서비스 아키텍처를 채택 해야 함
- 성취하고 하는 것을 명확하기 이해하지 못한다면 혼란을 가져올 수 있음  
- 마이크로 서비스에 집착하게 되면 다른 방법을 생각하지 못하도록 방해가 될 수 있음


## 점진적 마이그레이션
- 마이크로 시스템으로 전환을 결정했다면 점진적으로 시도 해야 함
- 마이크로 서비스는 쉽지 않다. 처음에는 단순한 것을 시도
- 점진적인 마이그레이션은 마이크로 서비스를 시작하는데 도움이 될 수 있음 

## 모놀리스가 적인 경우는 드물다.
- 모놀리식 아키텍처는 본질적으로 나쁘지 않음.
- 모놀리스가 없는 것에 집중하지 말고 아키텍처 변경으로 얻게될 이점에 집중 해야 함 
- 모놀리스와 마이크로 서비스가 공존하여도 무관, 모놀리스 서비스 소멸은 어려운 요구 사항

### 조급한 분해의 위험성
- 도메인에 대한 이해가 명확하지 않을 때는 마이크로서비스 적용에 위험 따름, 무모하게 적용시 결국 다시 하나의 모놀리식 시스템으로 갈 수 도 있음

## 무엇을 먼저 나눌까
- 마이크로서비스의 장점을 확실히 파악하고 이를 바탕으로 우선순위를 정해야 함  
- 너무 깊은 의존성을 가진 서비스라면 마이크로 서비스 전환시 실행 자체를 고려 해야 함
- 가장 쉬운 마이크로 서비스를 먼저 추출해보고 성공하지 못했다면 다시 고민 

## 계층별 분해
- 보통 백엔드 기능의 분해를 통해 얻는 혜택에만 집중하여 UI분해를 고려하지 않음.
때로는 UI분해로 가장 큰 혜택을 얻을 수 있음

### 코드 우선
- 코드를 먼저 새 마이크로 서비스로 옮기고 데이터베이스는 남겨 둠
- 단기적인 이익은 얻을 수 있으나 결국 미래에 겪을 문제를 많이 축적하게 됨 하지만 새로운 마이크로서비스를 통해 이점을 얻게 될 순 있음
- 코드를 깔끔하게 분리하지 못한다는 것은 곧 데이터베이스 연관성을 떼어낼 수 없다는 것
- 다만 코드 분리는 성공했으나 데이터베이스 분해는 어려울 수 있으니 스케치 작업은 필요

### 데이터 우선
- 데이터베이스를 코드보다 먼저 분리하는 방법
- 데이터를 확실히 분리할 수 있는지 판단이 어려울때 용이함
- 데이터를 먼저 분리 과정에서 경계가 어느정도 정의되고 그에 따라 서비스를 전체 추출하게 되는 위험을 피할 수 있음

## 유용한 분해 패턴

### 교살자 무하과 패턴
- 기존 시스템을 새 시스템으로 감싸면서 점점 이동 시킴.
- 외부에서 동일하게 기능 호출, 내부에서는 호출을 가로채 새로 추출된 서비스로 리다이렉트
- 모놀리스가 공존 하기 때문에 두 가지를 아키텍처를 모두 사용

### 병렬 실행
- 조직에서 중요한 기능을 마이크로 서비스로 추출할 때 유용
- 모놀리식 기능 구현과 새로운 마이크로 서비스 구현을 병행
- 같은 요청을 제공하고 결과를 비교 함

### 기능 토글
- 모놀리스 기능을 남겨두고 새로운 마이크로 서비스와 전환을 제어할 수 있게 메커니즘 제공
- 교살자 무화가 패턴이 토글을 proxy 방식으로 제공한게 그 예라고 할 수 있음

## 데이터 분해에 대한 우려
데이터를 분리 하여 서비스를 개발 시 고려 해야 하는 것들

### 성능 
- 관계형 데이터 베이스에서 조인은 매우 강력한 기능 어플리케이션에서 해당 기능을 따라잡긴 어려움
- 데이터 베이스에서 실행된 조인이 어플리케이션으로 옮겨지면서 병목 현상이 발생

### 데이터 무결성
- 데이터 베이스에서 외래키로 쉽게 데이터 무경설을 보장했지만 어플리케이션에서는 복잡하게 구현해야 함 
- 소프트 삭제가 해당 무결성 문제를 어느정도 해결해 줄 순 있음 하지만 동기화 문제는 해결해 주지 않음

### 트랜잭션
- 데이터 베이스의 트랜잭션을 사용할 수 없어 ACID 안정성을 읽게 됨
- 어플리케이션 분산 트랙잰션 구현은 매우 복잡함

### 도구
- 스키마 변경에 따라 버전을 관리 해주는 도구를 사용하기가 여러움

### 리포팅(관리자, 모니터링) 데이터 베이스
- 마이크로 서비스는 정보은닉 개념 기반으로 데이터베이스를 숨겨야 한다.
- 리포팅 데이터 베이스와 서비스에 관련된 데이터 베이스 두 곳 모두 데이터를 저장해야 함
- 이 과정에서 하나의 마이크로 서비스는 두개의 데이터 저장소에 엑세스 해야 함
- 리포팅 데이터 베이스에는 리포팅에 필요한 데이터만 노출
- 서비스가 내부 구현이 변경되도 호환성을 유지할 수 있게, 엔드포인트와 동일하게 취급






